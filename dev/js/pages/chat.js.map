{"version":3,"sources":["chat.jsx"],"names":[],"mappings":"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","file":"chat.js","sourcesContent":["/*jshint sub:true*/\n/*jshint -W030 */\n\nfunction ChatClass() {\n  this.url = \"/chat\";\n  this.historyMaxDaysBack = 20;\n  this.init = function(){\n    this.installObservers();\n    this.createReact();\n\t};\n\n  this.sortByDateProp = function(target_list, prop) {\n    return target_list.sort(function(a, b){\n      return Date.parse(b[prop]) - Date.parse(a[prop]);\n    })\n\n  };\n\n  this.createReact = function() {\n    var self = this;\n\n    var MatchSidebar = React.createClass({\n      loadUpdates: function() {\n        $.ajax({\n          type: \"POST\",\n          url: '/get_history',\n          data: {\n            'timestamp': self.initialFetch\n          },\n          dataType: 'json',\n          success: function(msg) {\n            var timestamp = msg.timestamp;\n            var historyData = self.sortByDateProp(msg.results, 'last_activity_date');\n\n            this.setState({data:historyData});\n            self.lastFetch = timestamp;\n          }.bind(this),\n          error: function(xhr, status, err) {\n            console.error(this.props.url, status, err.toString());\n          }.bind(this)\n        });\n      },\n      getInitialState: function() {\n        return {data:[]};\n      },\n      historyLooper: function(callback) {\n        var lookup = {\n          \"3\": 7,\n          \"7\": 14,\n          \"14\":20,\n        };\n\n        var current_history = parseInt(self.lastDayFetch);\n        var next = lookup[current_history];\n        alert('next is '+next);\n\n        if (next == 20) {\n          alert('start interval');\n          setInterval(this.loadUpdates, 5000);\n        }\n\n        this.collectHistory(next, function(){\n          callback();\n        });\n\n      },\n      collectHistory: function(days_back, callback) {\n        $.ajax({\n          type: \"POST\",\n          url: '/get_history',\n          data: {\n            'days_ago': parseInt(days_back)\n          },\n          dataType: 'json',\n          success: function(msg) {\n            var timestamp = msg.timestamp;\n            var historyData = self.sortByDateProp(msg.results, 'last_activity_date');\n\n            self.lastFetch = timestamp;\n            self.initialFetch = timestamp;\n            self.lastDayFetch = days_back;\n            this.setState({data:historyData});\n\n          }.bind(this),\n          error: function(xhr, status, err) {\n            console.error(this.props.url, status, err.toString());\n          }.bind(this)\n        });\n      },\n      componentDidMount: function() {\n        alert('mounted.');\n        console.log('mounted');\n        $.ajax({\n          type: \"POST\",\n          url: '/get_history',\n          data: {\n            'days_ago': 3\n          },\n          dataType: 'json',\n          success: function(msg) {\n            var timestamp = msg.timestamp;\n            var historyData = msg.results;\n\n            self.lastFetch = timestamp;\n            self.initialFetch = timestamp;\n            self.lastDayFetch = 3;\n            this.setState({data:historyData});\n\n            var activereact = this;\n            function loop() {\n              console.log(\"last day fetch: \"+ self.lastDayFetch);\n              console.log(\"history days back: \"+ self.historyMaxDaysBack);\n              if(self.lastDayFetch < self.historyMaxDaysBack) {\n                activereact.historyLooper(function(){\n                  loop();\n                });\n              }\n            }\n            loop();\n\n            console.log(\"NOW SETTING UPDATE INTERVAL\");\n\n          }.bind(this),\n          error: function(xhr, status, err) {\n            console.error(this.props.url, status, err.toString());\n          }.bind(this)\n        });\n      },\n      render: function() {\n        console.log('rendering...');\n        return (\n          <div className=\"matchSidebar\">\n            <MatchList data={this.state.data} />\n          </div>\n        )\n      }\n    });\n\n    var MatchList = React.createClass({\n      render: function() {\n        var matchNodes = this.props.data.map(function (match){\n          var last_three_messages = match['messages'].slice(-3);\n          var messaged = true;\n          if(match['messages'].length === 0) {\n            messaged = false\n          }\n          var last_messaged = moment(match.last_activity_date).fromNow();\n          var last_online = moment(match.person.ping_time).fromNow();\n\n          var messages_only = [];\n          $.each(last_three_messages, function(idx, val){\n            messages_only.push(val['message']);\n          });\n          return (\n            <MatchCell key={match._id}\n              profile={match['person']['photos'][0]['url']}\n              name={match['person']['name']}\n              last_three_messages={messages_only.join('<br />')}\n              messaged={messaged.toString()}\n              last_messaged={last_messaged}\n              last_online={last_online}\n              match_id={match['_id']} />\n          );\n        });\n        return  (\n          <div className=\"matchList\">\n            {matchNodes}\n          </div>\n        )\n      }\n    });\n\n\n    var MatchCell = React.createClass({\n      render: function() {\n        var messageExp = this.props.messaged === 'true' ? this.props['last_three_messages'] : 'no messages yet';\n        function createMessage() { return {\n          __html: messageExp\n        };}\n        return (\n          <div className=\"matchCell row\" match_id={this.props['match_id']} messaged={this.props['messaged']}>\n            <img className=\"col-md-4\" src={this.props['profile']} />\n            <div className=\"col-md-8\">\n              <span className=\"name\">{this.props['name']}</span>\n              <span className=\"lastonline\">last online {this.props['last_online']}</span>\n              <p dangerouslySetInnerHTML={createMessage()} />\n            </div>\n          </div>\n        )\n      }\n    });\n\n    ReactDOM.render(\n      <MatchSidebar data={this.historyData} />,\n      document.getElementById('match-list')\n    );\n  }\n\n  this.renderConvo = function() {\n    var ConvoBox = React.renderClass({\n      render: function() {\n        return (\n          <div className=\"convoBox\">\n            <ConvoHistoryBox match={this.props.data}/>\n          </div>\n        )\n      }\n    })\n\n    var ConvoHistoryBox = React.renderClass({\n      render: function() {\n        return (\n          <div className=\"convoHistoryBox\"></div>\n        )\n      }\n    });\n\n    var MessageBubble = React.renderClass({\n      render: function() {\n        return (\n          <div className=\"messageBubble\">\n            <div className=\"messageText\">\n              {this.props.message_text}\n            </div>\n          </div>\n        )\n      }\n    })\n\n    var active_match = this.historyData[0]\n    ReactDOM.render(\n      <ConvoBox data={active_match} />,\n      document.getElementById('active-convo')\n    );\n  };\n\n  this.getUpdates = function(timestamp, callback) {\n    $.ajax({\n        type: \"POST\",\n        url: '/get_history',\n        data: {\n          'timestamp': timestamp\n        },\n        dataType: 'json',\n        success: function(msg) {\n          callback(msg.results, msg.timestamp);\n        }\n      });\n  };\n\n  this.getHistory = function(days_ago, callback) {\n    console.log('get history');\n    $.ajax({\n        type: \"POST\",\n        url: '/get_history',\n        data: {\n          'days_ago': days_ago\n        },\n        dataType: 'json',\n        success: function(msg) {\n          callback(msg.results, msg.timestamp);\n        }\n      });\n  };\n\n\tthis.installObservers = function(){\n\t};\n\n}\n\nvar Chat = new ChatClass();\n\n// MatchList\n//   MatchCell\n"]}